# GitHub Actions workflow cho ứng dụng Flutter Weather App
# Tác giả: nhaico12345

name: Flutter CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cài đặt Java (bắt buộc cho Android build)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Cài đặt Flutter SDK
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: 'stable'
          cache: true

      # Hiển thị thông tin Flutter
      - name: Flutter version info
        run: flutter --version

      # Tạo file .env (nếu cần thiết cho build)
      # Sử dụng GitHub Secrets để bảo mật API keys
      - name: Create .env file
        run: |
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" > .env

      # Cài đặt dependencies
      - name: Install dependencies
        run: flutter pub get

      # Kiểm tra format code (tùy chọn - bỏ comment nếu muốn enforce)
      # - name: Verify formatting
      #   run: dart format --output=none --set-exit-if-changed .

      # Phân tích code tĩnh
      - name: Analyze project source
        run: flutter analyze

      # Chạy tests
      - name: Run tests
        run: flutter test

      # Build APK cho Android (Debug - nhanh hơn cho CI)
      - name: Build APK (Debug)
        run: flutter build apk --debug

      # Build APK Release (tùy chọn - bỏ comment nếu muốn)
      # - name: Build APK (Release)
      #   run: flutter build apk --release

      # Upload APK artifact (để download sau khi build thành công)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: build/app/outputs/flutter-apk/app-debug.apk

  # Job riêng cho iOS build (chỉ chạy trên macOS runner)
  # build-ios:
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.29.0'
  #         channel: 'stable'
  #         cache: true
  #     - name: Create .env file
  #       run: echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" > .env
  #     - run: flutter pub get
  #     - run: flutter build ios --release --no-codesign
